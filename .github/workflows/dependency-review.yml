name: 'Dependency review'
on:
  pull_request:
    branches: ["main"]
    paths:
      - 'package.json'
      - 'package-lock.json'

permissions:
  contents: read
  pull-requests: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  dependency-review:
    runs-on: ubuntu-latest
    steps:
      - name: 'Checkout repository'
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: 'Setup Node.js'
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: '20'

      - name: 'Dependency Review'
        uses: actions/dependency-review-action@3c4e3dcb1aa7874d2c16be7d79418e9b7efd6261 # v4.8.2
        with:
          comment-summary-in-pr: always
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: 'Install dependencies'
        run: npm ci

      - name: 'Security Audit'
        id: audit
        run: |
          echo "## üîí Security Audit Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          AUDIT_OUTPUT=$(npm audit --audit-level=moderate 2>&1 || true)

          if echo "$AUDIT_OUTPUT" | grep -q "found 0 vulnerabilities"; then
            echo "‚úÖ No known vulnerabilities found" >> $GITHUB_STEP_SUMMARY
            echo "audit_status=clean" >> $GITHUB_OUTPUT
          else
            echo "‚ö†Ô∏è Vulnerabilities detected:" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "$AUDIT_OUTPUT" | head -50 >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "audit_status=warning" >> $GITHUB_OUTPUT
          fi

      - name: 'License Check'
        id: license
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## üìú License Compliance Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Install license-checker-rseidelsohn for detailed reporting
          npm install -g license-checker-rseidelsohn

          echo "### üìä License Summary" >> $GITHUB_STEP_SUMMARY
          license-checker-rseidelsohn --summary >> $GITHUB_STEP_SUMMARY

          # Define forbidden licenses (Copyleft licenses that might conflict with privacy-first/proprietary goals)
          FORBIDDEN_LICENSES="GPL-2.0-only,GPL-2.0-or-later,GPL-3.0-only,GPL-3.0-or-later,AGPL-3.0-only,AGPL-3.0-or-later,LGPL-2.0-only,LGPL-2.0-or-later,LGPL-2.1-only,LGPL-2.1-or-later,LGPL-3.0-only,LGPL-3.0-or-later"
          
          # Check for forbidden licenses
          VIOLATIONS=$(license-checker-rseidelsohn --failOn "$FORBIDDEN_LICENSES" 2>&1 || true)
          
          if echo "$VIOLATIONS" | grep -q "package(s) using a forbidden license"; then
            echo "‚ùå **License Violation Detected!**" >> $GITHUB_STEP_SUMMARY
            echo "The following packages use restricted licenses:" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "$VIOLATIONS" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "license_status=violation" >> $GITHUB_OUTPUT
          else
            echo "‚úÖ All dependencies comply with the license policy." >> $GITHUB_STEP_SUMMARY
            echo "license_status=ok" >> $GITHUB_OUTPUT
          fi

      - name: 'Dependency Size Check'
        id: size
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## üì¶ Dependency Size Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          NODE_MODULES_SIZE=$(du -sh node_modules 2>/dev/null | cut -f1 || echo "unknown")
          DEPENDENCY_COUNT=$(npm ls --depth=0 2>/dev/null | grep -c "^[‚îú‚îî]" || echo "0")

          echo "- **node_modules size**: $NODE_MODULES_SIZE" >> $GITHUB_STEP_SUMMARY
          echo "- **Direct dependencies**: $DEPENDENCY_COUNT" >> $GITHUB_STEP_SUMMARY

          echo "size=$NODE_MODULES_SIZE" >> $GITHUB_OUTPUT
          echo "count=$DEPENDENCY_COUNT" >> $GITHUB_OUTPUT

      - name: 'Create PR Comment'
        if: github.event_name == 'pull_request'
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const auditStatus = '${{ steps.audit.outputs.audit_status }}';
            const licenseStatus = '${{ steps.license.outputs.license_status }}';
            const depSize = '${{ steps.size.outputs.size }}';
            const depCount = '${{ steps.size.outputs.count }}';

            const statusEmoji = (status) => {
              if (status === 'clean' || status === 'ok') return '‚úÖ';
              if (status === 'warning' || status === 'violation') return '‚ö†Ô∏è';
              return '‚ùì';
            };

            const body = `## üîç Dependency Review Summary

            | Check | Status | Details |
            |-------|--------|---------|
            | Security Audit | ${statusEmoji(auditStatus)} | ${auditStatus === 'clean' ? 'No vulnerabilities' : 'Review required'} |
            | License Check | ${statusEmoji(licenseStatus)} | ${licenseStatus === 'ok' ? 'Compliant' : 'Violation detected'} |
            | Dependencies | üì¶ | ${depCount} direct, ${depSize} total |

            ${auditStatus === 'warning' || licenseStatus === 'violation' ? '‚ö†Ô∏è **Action Required**: Please review the audit findings in the [Workflow Summary](' + process.env.GITHUB_SERVER_URL + '/' + process.env.GITHUB_REPOSITORY + '/actions/runs/' + process.env.GITHUB_RUN_ID + ').' : ''}
            `;

            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });
