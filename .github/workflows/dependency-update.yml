name: Dependency Update

on:
  schedule:
    - cron: '0 6 * * 1'
  workflow_dispatch:
    inputs:
      target:
        description: 'Target to update (npm/actions/all)'
        required: false
        default: 'all'

permissions:
  contents: write
  pull-requests: write

jobs:
  update-npm:
    name: Update npm Dependencies
    runs-on: ubuntu-latest
    if: github.event.inputs.target == 'all' || github.event.inputs.target == 'npm' || github.event_name == 'schedule'
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2

      - name: Setup Node.js
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238  # v6.2.0
        with:
          node-version: '20'

      - name: Update dependencies
        run: |
          npm update
          npm audit fix --only=prod || true

      - name: Check for changes
        id: check
        run: |
          if git diff --quiet package.json package-lock.json; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Create Pull Request
        if: steps.check.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@c0f553fe549906ede9cf27b5156039d195d2ece0  # v8.1.0
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'deps: update npm dependencies'
          title: 'deps: update npm dependencies'
          body: |
            ## ðŸ“¦ npm Dependencies Update

            This PR updates npm dependencies to their latest compatible versions.

            ### Changes
            - Updated dependencies to latest compatible versions
            - Applied security fixes where available

            **Auto-generated by dependency-update workflow**
          branch: deps/npm-update
          labels: dependencies,automated

  update-actions:
    name: Update GitHub Actions
    runs-on: ubuntu-latest
    if: github.event.inputs.target == 'all' || github.event.inputs.target == 'actions' || github.event_name == 'schedule'
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2

      - name: Update GitHub Actions
        run: |
          echo "Checking for GitHub Actions updates..."
          
          # List of actions to check (with their commit hashes)
          declare -A ACTIONS=(
            ["actions/checkout"]="de0fac2e4500dabe0009e67214ff5f5447ce83dd"
            ["actions/setup-node"]="6044e13b5dc448c55e2357c09f80417699197238"
            ["codecov/codecov-action"]="671740ac38dd9b0130fbe1cec585b89eea48d3de"
            ["SonarSource/sonarqube-scan-action"]="a31c9398be7ace6bbfaf30c0bd5d415f843d45e9"
            ["actions/cache"]="cdf6c1fa76f9f475f3d7449005a359c84ca0f306"
            ["actions/upload-artifact"]="b7c566a772e6b6bfb58ed0dc250532a479d7789f"
            ["actions/download-artifact"]="634f93cb2916e3fdff6788551b99b062d0335ce0"
            ["actions/github-script"]="60a0d83039c74a4aee543508d2ffcb1c3799cdea"
            ["softprops/action-gh-release"]="a06a81a03ee405af7f2048a818ed3f03bbf83c7b"
            ["actions/dependency-review-action"]="3c4e3dcb1aa7874d2c16be7d79418e9b7efd6261"
            ["peter-evans/create-pull-request"]="c0f553fe549906ede9cf27b5156039d195d2ece0"
          )
          
          for action in "${!ACTIONS[@]}"; do
            current_hash="${ACTIONS[$action]}"
            latest_tag=$(curl -s "https://api.github.com/repos/${action}/tags" | jq -r '.[0].name')
            latest_hash=$(curl -s "https://api.github.com/repos/${action}/tags" | jq -r '.[0].commit.sha')
            
            if [ "$current_hash" != "$latest_hash" ] && [ -n "$latest_hash" ]; then
              echo "Update available for $action: $current_hash -> $latest_hash ($latest_tag)"
            fi
          done

      - name: Check for changes
        id: check
        run: |
          if git diff --quiet .github/workflows/; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Create Pull Request
        if: steps.check.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@c0f553fe549906ede9cf27b5156039d195d2ece0  # v8.1.0
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'ci: update GitHub Actions to latest versions'
          title: 'ci: update GitHub Actions to latest versions'
          body: |
            ## ðŸ”§ GitHub Actions Update

            This PR updates GitHub Actions to their latest versions with pinned commit hashes.

            ### Security
            All actions are pinned to specific commit hashes for supply chain security.

            **Auto-generated by dependency-update workflow**
          branch: deps/actions-update
          labels: github-actions,dependencies,automated
