name: æ„å»ºä¸æ£€æŸ¥æµè§ˆå™¨æ‰©å±•

on:
  push:
    branches: [main, beta, release]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      create_release:
        description: "åˆ›å»ºå‘å¸ƒç‰ˆæœ¬"
        required: false
        default: false
        type: boolean
      skip_tests:
        description: "è·³è¿‡ E2E æµ‹è¯•ï¼ˆåŠ å¿«æ„å»ºé€Ÿåº¦ï¼‰"
        required: false
        default: false
        type: boolean

permissions:
  actions: read
  contents: write
  pull-requests: write
  security-events: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: "20"
  EXTENSION_SIZE_LIMIT_MB: 10

jobs:
  lint:
    name: ä»£ç æ£€æŸ¥ä¸æ ¼å¼éªŒè¯
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: æ£€å‡ºä»“åº“
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2

      - name: é…ç½® Node.js
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238  # v6.2.0
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ç¼“å­˜ node_modules å’Œ npm ç¼“å­˜
        uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306  # v5.0.3
        id: npm-cache
        with:
          path: |
            node_modules
            ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: å®‰è£…ä¾èµ–
        if: steps.npm-cache.outputs.cache-hit != 'true'
        run: npm ci --prefer-offline

      - name: TypeScript ç±»å‹æ£€æŸ¥
        run: npx tsc --noEmit

      - name: ESLint ä»£ç æ£€æŸ¥
        run: npm run lint

      - name: Prettier æ ¼å¼æ£€æŸ¥
        run: npm run format:check

  test:
    name: å•å…ƒæµ‹è¯• (Node.js ${{ matrix.node-version }})
    runs-on: ubuntu-latest
    timeout-minutes: 15
    strategy:
      matrix:
        node-version: [18, 20]
    steps:
      - name: æ£€å‡ºä»“åº“
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2
        with:
          fetch-depth: 0

      - name: é…ç½® Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238  # v6.2.0
        with:
          node-version: ${{ matrix.node-version }}

      - name: ç¼“å­˜ node_modules å’Œ npm ç¼“å­˜
        uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306  # v5.0.3
        id: npm-cache
        with:
          path: |
            node_modules
            ~/.npm
          key: ${{ runner.os }}-node${{ matrix.node-version }}-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node${{ matrix.node-version }}-
            ${{ runner.os }}-node-

      - name: å®‰è£…ä¾èµ–
        if: steps.npm-cache.outputs.cache-hit != 'true'
        run: npm ci --prefer-offline

      - name: è¿è¡Œå•å…ƒæµ‹è¯•å¹¶ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
        run: npm run test:coverage

      - name: ä¸Šä¼ è¦†ç›–ç‡åˆ° Codecov
        if: always()
        uses: codecov/codecov-action@671740ac38dd9b0130fbe1cec585b89eea48d3de  # v5.5.2
        with:
          files: ./coverage/lcov.info
          flags: unittests
          fail_ci_if_error: false
          token: ${{ secrets.CODECOV_TOKEN }}

      - name: SonarCloud ä»£ç æ‰«æ
        uses: SonarSource/sonarqube-scan-action@a31c9398be7ace6bbfaf30c0bd5d415f843d45e9  # v7.0.0
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  security:
    name: å®‰å…¨æ‰«æ
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: æ£€å‡ºä»“åº“
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2
        with:
          fetch-depth: 0

      - name: é…ç½® Node.js
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238  # v6.2.0
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ç¼“å­˜ node_modules å’Œ npm ç¼“å­˜
        uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306  # v5.0.3
        id: npm-cache
        with:
          path: |
            node_modules
            ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: å®‰è£…ä¾èµ–
        if: steps.npm-cache.outputs.cache-hit != 'true'
        run: npm ci --prefer-offline

      - name: æ£€æŸ¥å¯†é’¥æ³„éœ²
        uses: trufflesecurity/trufflehog@6961f2bace57ab32b23b3ba40f8f420f6bc7e004  # v3.93.3
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          extra_args: --only-verified

      - name: ä¾èµ–å®‰å…¨å®¡è®¡
        run: |
          echo "### ğŸ›¡ï¸ ä¾èµ–å®‰å…¨å®¡è®¡" >> $GITHUB_STEP_SUMMARY
          echo "<details><summary>ç‚¹å‡»æŸ¥çœ‹å®Œæ•´å®¡è®¡æŠ¥å‘Š</summary>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          npm audit --audit-level=moderate >> $GITHUB_STEP_SUMMARY 2>&1 || true
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "</details>" >> $GITHUB_STEP_SUMMARY
        continue-on-error: true

      - name: å®‰å…¨æ¨¡å¼æ£€æŸ¥
        run: |
          echo "### ğŸ” å®‰å…¨æ¨¡å¼æ£€æŸ¥" >> $GITHUB_STEP_SUMMARY
          EXIT_CODE=0
          
          echo "#### eval ä½¿ç”¨æ£€æŸ¥" >> $GITHUB_STEP_SUMMARY
          if grep -r "eval(" --include="*.ts" --include="*.tsx" --include="*.js" . 2>/dev/null | grep -v node_modules | grep -v ".plasmo"; then
            echo "âŒ å‘ç° eval() ä½¿ç”¨ - æ½œåœ¨å®‰å…¨é£é™©" >> $GITHUB_STEP_SUMMARY
            EXIT_CODE=1
          else
            echo "âœ… æœªå‘ç° eval() ä½¿ç”¨" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "#### dangerouslySetInnerHTML æ£€æŸ¥" >> $GITHUB_STEP_SUMMARY
          if grep -r "dangerouslySetInnerHTML" --include="*.ts" --include="*.tsx" --include="*.js" . 2>/dev/null | grep -v node_modules | grep -v ".plasmo"; then
            echo "âš ï¸ å‘ç° dangerouslySetInnerHTML ä½¿ç”¨ - XSS é£é™©" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… æœªå‘ç° dangerouslySetInnerHTML ä½¿ç”¨" >> $GITHUB_STEP_SUMMARY
          fi
          
          exit $EXIT_CODE

  build:
    name: æ„å»ºæ‰©å±•
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [lint, test]
    if: always() && (needs.lint.result == 'success' || needs.lint.result == 'skipped') && (needs.test.result == 'success' || needs.test.result == 'skipped')
    outputs:
      version: ${{ steps.version.outputs.version }}
      name: ${{ steps.version.outputs.name }}
    steps:
      - name: æ£€å‡ºä»“åº“
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2

      - name: é…ç½® Node.js
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238  # v6.2.0
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ç¼“å­˜ node_modules å’Œ npm ç¼“å­˜
        uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306  # v5.0.3
        id: npm-cache
        with:
          path: |
            node_modules
            ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: å®‰è£…ä¾èµ–
        if: steps.npm-cache.outputs.cache-hit != 'true'
        run: npm ci --prefer-offline

      - name: ç¼“å­˜ Plasmo æ„å»ºç¼“å­˜
        uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306  # v5.0.3
        with:
          path: .plasmo
          key: ${{ runner.os }}-plasmo-${{ hashFiles('**/package-lock.json', 'src/**/*') }}
          restore-keys: |
            ${{ runner.os }}-plasmo-

      - name: æ„å»ºæ‰©å±•
        run: npm run build

      - name: è·å–ç‰ˆæœ¬ä¿¡æ¯
        id: version
        run: |
          VERSION=$(jq -r '.version' package.json)
          NAME=$(jq -r '.name' package.json)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "name=$NAME" >> $GITHUB_OUTPUT

      - name: æ£€æŸ¥æ‰©å±•ä½“ç§¯
        run: |
          BUILD_DIR="build/chrome-mv3-prod"
          if [ -d "$BUILD_DIR" ]; then
            SIZE_KB=$(du -sk "$BUILD_DIR" | cut -f1)
            SIZE_MB=$((SIZE_KB / 1024))
            echo "ğŸ“Š æ‰©å±•ä½“ç§¯: ${SIZE_MB}MB (${SIZE_KB}KB)"
            
            if [ "$SIZE_MB" -gt "${{ env.EXTENSION_SIZE_LIMIT_MB }}" ]; then
              echo "âŒ æ‰©å±•ä½“ç§¯ (${SIZE_MB}MB) è¶…å‡ºé™åˆ¶ (${{ env.EXTENSION_SIZE_LIMIT_MB }}MB)"
              exit 1
            fi
            echo "âœ… æ‰©å±•ä½“ç§¯ç¬¦åˆé™åˆ¶"
          fi

      - name: éªŒè¯æ„å»ºäº§ç‰©
        run: |
          BUILD_DIR="build/chrome-mv3-prod"
          
          if [ ! -d "$BUILD_DIR" ]; then
            echo "âŒ æ„å»ºç›®å½•ä¸å­˜åœ¨: $BUILD_DIR"
            exit 1
          fi
          
          echo "ğŸ“ æ„å»ºå†…å®¹:"
          ls -la "$BUILD_DIR"
          
          REQUIRED_FILES=("manifest.json" "popup.html")
          for file in "${REQUIRED_FILES[@]}"; do
            if [ -f "$BUILD_DIR/$file" ]; then
              echo "âœ… $file å­˜åœ¨"
            else
              echo "âŒ $file ç¼ºå¤±"
              exit 1
            fi
          done
          
          if [ -f "$BUILD_DIR/manifest.json" ]; then
            echo "ğŸ“„ Manifest å†…å®¹:"
            jq '.' "$BUILD_DIR/manifest.json"
          fi

      - name: æ‰“åŒ…æ‰©å±•
        run: npm run package

      - name: é‡å‘½åæ„å»ºäº§ç‰©
        run: |
          VERSION=${{ steps.version.outputs.version }}
          NAME=${{ steps.version.outputs.name }}
          
          if [ -d "build/chrome-mv3-prod" ]; then
            mv "build/chrome-mv3-prod" "build/${NAME}-${VERSION}-chrome"
          fi
          
          if [ -f "build/chrome-mv3-prod.zip" ]; then
            mv "build/chrome-mv3-prod.zip" "build/${NAME}-${VERSION}-chrome.zip"
          fi

      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f  # v6.0.0
        with:
          name: extension-${{ steps.version.outputs.version }}
          path: build/
          retention-days: 7

  e2e:
    name: E2E æµ‹è¯•
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: [build]
    if: always() && needs.build.result == 'success' && github.event.inputs.skip_tests != 'true'
    steps:
      - name: æ£€å‡ºä»“åº“
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2

      - name: é…ç½® Node.js
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238  # v6.2.0
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ç¼“å­˜ node_modules å’Œ npm ç¼“å­˜
        uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306  # v5.0.3
        id: npm-cache
        with:
          path: |
            node_modules
            ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: å®‰è£…ä¾èµ–
        if: steps.npm-cache.outputs.cache-hit != 'true'
        run: npm ci --prefer-offline

      - name: ä¸‹è½½æ„å»ºäº§ç‰©
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131  # v7.0.0
        with:
          pattern: extension-*
          path: build/
          merge-multiple: true

      - name: å‡†å¤‡æµ‹è¯•æ‰©å±•
        run: |
          VERSION=$(jq -r '.version' package.json)
          NAME=$(jq -r '.name' package.json)
          
          if [ -d "build/${NAME}-${VERSION}-chrome" ]; then
            mv "build/${NAME}-${VERSION}-chrome" "build/chrome-mv3-prod"
          fi
          
          ls -la build/

      - name: å®‰è£… Playwright æµè§ˆå™¨
        run: npx playwright install --with-deps chromium

      - name: è¿è¡Œ E2E æµ‹è¯•
        run: xvfb-run --auto-servernum npm run test:e2e

      - name: ä¸Šä¼  Playwright æŠ¥å‘Š
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f  # v6.0.0
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 30

  pr-comment:
    name: PR è¯„è®º
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [lint, test, security, build, e2e]
    if: always() && github.event_name == 'pull_request'
    steps:
      - name: æ£€å‡ºä»“åº“
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2

      - name: è·å–ç‰ˆæœ¬ä¿¡æ¯
        id: info
        run: |
          VERSION=$(jq -r '.version' package.json)
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: æ£€æŸ¥æ˜¯å¦ä¸º Dependabot PR
        id: dependabot
        run: |
          if [ "${{ github.actor }}" = "dependabot[bot]" ]; then
            echo "is_dependabot=true" >> $GITHUB_OUTPUT
          else
            echo "is_dependabot=false" >> $GITHUB_OUTPUT
          fi

      - name: åˆ›å»º PR è¯„è®º
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd  # v8.0.0
        with:
          script: |
            const lintResult = '${{ needs.lint.result }}';
            const testResult = '${{ needs.test.result }}';
            const securityResult = '${{ needs.security.result }}';
            const buildResult = '${{ needs.build.result }}';
            const e2eResult = '${{ needs.e2e.result }}';
            const version = '${{ steps.info.outputs.version }}';
            const isDependabot = '${{ steps.dependabot.outputs.is_dependabot }}' === 'true';
            
            const statusEmoji = (result) => {
              if (result === 'success') return 'âœ…';
              if (result === 'failure') return 'âŒ';
              if (result === 'skipped') return 'â­ï¸';
              return 'âš ï¸';
            };
            
            const getBadge = (label, result) => {
              const color = result === 'success' ? 'brightgreen' : (result === 'failure' ? 'red' : 'yellow');
              return `![${label}](https://img.shields.io/badge/${label}-${result}-${color}?style=flat-square)`;
            };

            let body = `## ğŸ› ï¸ æ‰©å±•æ„å»ºä»ªè¡¨ç›˜\n\n`;
            body += `${getBadge('ä»£ç æ£€æŸ¥', lintResult)} ${getBadge('å•å…ƒæµ‹è¯•', testResult)} ${getBadge('å®‰å…¨æ‰«æ', securityResult)} ${getBadge('æ„å»º', buildResult)} ${getBadge('E2Eæµ‹è¯•', e2eResult)}\n\n`;
            
            body += `### ğŸ“Š æ£€æŸ¥è¯¦æƒ…\n\n`;
            body += `| æ£€æŸ¥é¡¹ | çŠ¶æ€ | è¯´æ˜ |\n`;
            body += `| :--- | :---: | :--- |\n`;
            body += `| **ä»£ç æ£€æŸ¥ä¸æ ¼å¼** | ${statusEmoji(lintResult)} | ä»£ç é£æ ¼ä¸é™æ€åˆ†æ |\n`;
            body += `| **å•å…ƒæµ‹è¯•** | ${statusEmoji(testResult)} | åŠŸèƒ½æ­£ç¡®æ€§ä¸è¦†ç›–ç‡ |\n`;
            body += `| **å®‰å…¨æ‰«æ** | ${statusEmoji(securityResult)} | å¯†é’¥æ³„éœ²ä¸ä¾èµ–å®¡è®¡ |\n`;
            body += `| **æ‰©å±•æ„å»º** | ${statusEmoji(buildResult)} | Plasmo ç”Ÿäº§æ„å»ºä¸ä½“ç§¯æ£€æŸ¥ |\n`;
            body += `| **E2E æµ‹è¯•** | ${statusEmoji(e2eResult)} | æµè§ˆå™¨è‡ªåŠ¨åŒ–æµ‹è¯• (Playwright) |\n\n`;
            
            body += `**ç‰ˆæœ¬:** \`${version}\` | **ç¯å¢ƒ:** \`ç”Ÿäº§ç¯å¢ƒ\`\n\n`;
            
            if (buildResult === 'success') {
              body += `> ğŸ“¦ **æ„å»ºäº§ç‰©:** æ„å»ºäº§ç‰©å¯åœ¨ [å·¥ä½œæµè¿è¡Œ](${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID}) ä¸­ä¸‹è½½ã€‚\n\n`;
            }
            
            if (isDependabot) {
              body += `---\n### ğŸ¤– Dependabot è‡ªåŠ¨åŒ–\n`;
              if (lintResult === 'success' && testResult === 'success' && securityResult === 'success' && buildResult === 'success') {
                body += `âœ… æ‰€æœ‰å…³é”®æ£€æŸ¥å·²é€šè¿‡ã€‚æ­¤ PR å·²æ ‡è®°ä¸ºè‡ªåŠ¨æ‰¹å‡†ã€‚\n`;
              } else {
                body += `âš ï¸ éƒ¨åˆ†æ£€æŸ¥æœªé€šè¿‡ã€‚éœ€è¦äººå·¥å®¡æ ¸ã€‚\n`;
              }
            }
            
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });

  notify-failure:
    name: å¤±è´¥é€šçŸ¥
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [lint, test, security, build, e2e]
    if: failure() && github.event_name != 'pull_request'
    steps:
      - name: åˆ›å»ºå¤±è´¥æ‘˜è¦
        run: |
          echo "## âŒ æ„å»ºå¤±è´¥" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| ä»»åŠ¡ | çŠ¶æ€ |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ä»£ç æ£€æŸ¥ | ${{ needs.lint.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| å•å…ƒæµ‹è¯• | ${{ needs.test.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| å®‰å…¨æ‰«æ | ${{ needs.security.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| æ„å»º | ${{ needs.build.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| E2E æµ‹è¯• | ${{ needs.e2e.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "è¯·æŸ¥çœ‹æ—¥å¿—äº†è§£è¯¦æƒ…ã€‚" >> $GITHUB_STEP_SUMMARY

  release:
    name: åˆ›å»ºå‘å¸ƒç‰ˆæœ¬
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [build, e2e, security]
    if: |
      always() &&
      needs.build.result == 'success' &&
      (needs.e2e.result == 'success' || needs.e2e.result == 'skipped') &&
      (needs.security.result == 'success' || needs.security.result == 'skipped') &&
      github.event_name == 'workflow_dispatch' &&
      github.event.inputs.create_release == 'true'
    steps:
      - name: æ£€å‡ºä»“åº“
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2
        with:
          fetch-depth: 0

      - name: è·å–ç‰ˆæœ¬ä¿¡æ¯
        id: version
        run: |
          VERSION=$(jq -r '.version' package.json)
          NAME=$(jq -r '.name' package.json)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "name=$NAME" >> $GITHUB_OUTPUT

      - name: ä¸‹è½½æ„å»ºäº§ç‰©
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131  # v7.0.0
        with:
          pattern: extension-*
          path: build/
          merge-multiple: true

      - name: ç”Ÿæˆæ›´æ–°æ—¥å¿—
        id: changelog
        run: |
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          CURRENT_VERSION="${{ steps.version.outputs.version }}"
          
          if [ -z "$PREVIOUS_TAG" ]; then
            NOTES=$(npx git-cliff --strip header 2>/dev/null || echo "åˆå§‹å‘å¸ƒ v${CURRENT_VERSION}")
          else
            NOTES=$(npx git-cliff "${PREVIOUS_TAG}..HEAD" --strip header 2>/dev/null || echo "å‘å¸ƒ v${CURRENT_VERSION}")
          fi
          
          if [ -z "$NOTES" ] || [ "$NOTES" = "## [Unreleased]" ]; then
            NOTES="## æ›´æ–°å†…å®¹\n\n- ç‰ˆæœ¬æ›´æ–°è‡³ ${CURRENT_VERSION}"
          fi
          
          echo "notes<<EOF" >> $GITHUB_OUTPUT
          echo -e "$NOTES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: æ£€æŸ¥æ ‡ç­¾æ˜¯å¦å­˜åœ¨
        id: check_tag
        run: |
          if git rev-parse "v${{ steps.version.outputs.version }}" >/dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: åˆ›å»ºå‘å¸ƒç‰ˆæœ¬
        if: steps.check_tag.outputs.exists == 'false'
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b  # v2.5.0
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: å‘å¸ƒ v${{ steps.version.outputs.version }}
          body: ${{ steps.changelog.outputs.notes }}
          files: |
            build/*.zip
          draft: false
          prerelease: ${{ github.ref != 'refs/heads/main' }}
          generate_release_notes: false

      - name: å‘å¸ƒæ‘˜è¦
        run: |
          echo "## ğŸ‰ å‘å¸ƒå·²åˆ›å»º" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ç‰ˆæœ¬:** v${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ“¦ å‘å¸ƒèµ„æº:" >> $GITHUB_STEP_SUMMARY
          ls -la build/*.zip >> $GITHUB_STEP_SUMMARY 2>/dev/null || echo "æœªæ‰¾åˆ° zip æ–‡ä»¶" >> $GITHUB_STEP_SUMMARY

  dependabot-approve:
    name: Dependabot è‡ªåŠ¨æ‰¹å‡†
    runs-on: ubuntu-latest
    needs: [lint, test, security, build, e2e]
    if: |
      github.event_name == 'pull_request' &&
      github.actor == 'dependabot[bot]' &&
      needs.lint.result == 'success' &&
      needs.test.result == 'success' &&
      needs.security.result == 'success' &&
      needs.build.result == 'success' &&
      (needs.e2e.result == 'success' || needs.e2e.result == 'skipped')
    permissions:
      pull-requests: write
    steps:
      - name: æ‰¹å‡† Dependabot PR
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd  # v8.0.0
        with:
          script: |
            github.rest.pulls.createReview({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
              event: 'APPROVE',
              body: 'ğŸ¤– Dependabot PR å·²é€šè¿‡æ‰€æœ‰æ£€æŸ¥ï¼Œè‡ªåŠ¨æ‰¹å‡†ã€‚'
            })
